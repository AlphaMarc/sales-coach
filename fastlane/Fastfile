default_platform(:mac)

platform :mac do
  desc "Build debug version"
  lane :build_debug do
    # Copy whisper binaries to resources if they exist
    if File.exist?("../whisper.cpp/main")
      sh("cp ../whisper.cpp/main ../SalesCoach/Resources/whisper-cli")
    end
    
    # Copy Large v3 Turbo model and Core ML encoder
    model_name = "ggml-large-v3-turbo-q5_0.bin"
    encoder_name = "ggml-large-v3-turbo-encoder.mlmodelc"
    
    if File.exist?("../whisper.cpp/models/#{model_name}")
      sh("cp ../whisper.cpp/models/#{model_name} ../SalesCoach/Resources/")
      UI.message("Copied #{model_name} from whisper.cpp")
    end
    
    if File.exist?("../whisper.cpp/models/#{encoder_name}")
      sh("cp -R ../whisper.cpp/models/#{encoder_name} ../SalesCoach/Resources/")
      UI.message("Copied #{encoder_name} from whisper.cpp")
    end
    
    if File.exist?("../whisper.cpp/ggml-metal.metal")
      sh("cp ../whisper.cpp/ggml-metal.metal ../SalesCoach/Resources/")
      UI.message("Copied ggml-metal.metal from whisper.cpp")
    end
    
    # Clean and create build directory
    sh("rm -rf ../build && mkdir -p ../build")
    
    # Build using xcodebuild directly for local development
    xcodebuild(
      project: "SalesCoach/SalesCoach.xcodeproj",
      scheme: "SalesCoach",
      configuration: "Debug",
      build_settings: {
        "CODE_SIGN_IDENTITY" => "-",
        "CODE_SIGNING_REQUIRED" => "NO",
        "CODE_SIGNING_ALLOWED" => "NO",
        "CONFIGURATION_BUILD_DIR" => File.expand_path("../build")
      },
      build: true
    )
    
    # Copy whisper-cli to app bundle Resources (Xcode doesn't copy executables without extension)
    app_resources = File.expand_path("../build/SalesCoach.app/Contents/Resources")
    whisper_src = File.expand_path("../SalesCoach/Resources/whisper-cli")
    if File.exist?(whisper_src)
      sh("cp '#{whisper_src}' '#{app_resources}/'")
      sh("chmod +x '#{app_resources}/whisper-cli'")
      UI.success("Copied whisper-cli to app bundle")
    else
      UI.error("whisper-cli not found at #{whisper_src}")
    end
    
    # Copy model and Core ML artifacts to app bundle (in case Xcode didn't include them)
    model_src = File.expand_path("../SalesCoach/Resources/#{model_name}")
    if File.exist?(model_src) && !File.exist?("#{app_resources}/#{model_name}")
      sh("cp '#{model_src}' '#{app_resources}/'")
      UI.success("Copied #{model_name} to app bundle")
    end
    
    encoder_src = File.expand_path("../SalesCoach/Resources/#{encoder_name}")
    if File.exist?(encoder_src) && !File.exist?("#{app_resources}/#{encoder_name}")
      sh("cp -R '#{encoder_src}' '#{app_resources}/'")
      UI.success("Copied #{encoder_name} to app bundle")
    end
    
    metal_src = File.expand_path("../SalesCoach/Resources/ggml-metal.metal")
    if File.exist?(metal_src) && !File.exist?("#{app_resources}/ggml-metal.metal")
      sh("cp '#{metal_src}' '#{app_resources}/'")
      UI.success("Copied ggml-metal.metal to app bundle")
    end
  end

  desc "Build release version"
  lane :build_release do
    # Copy whisper binaries to resources
    if File.exist?("../whisper.cpp/main")
      sh("cp ../whisper.cpp/main ../SalesCoach/Resources/whisper-cli")
    end
    
    # Copy Large v3 Turbo model and Core ML encoder
    model_name = "ggml-large-v3-turbo-q5_0.bin"
    encoder_name = "ggml-large-v3-turbo-encoder.mlmodelc"
    
    if File.exist?("../whisper.cpp/models/#{model_name}")
      sh("cp ../whisper.cpp/models/#{model_name} ../SalesCoach/Resources/")
      UI.message("Copied #{model_name} from whisper.cpp")
    end
    
    if File.exist?("../whisper.cpp/models/#{encoder_name}")
      sh("cp -R ../whisper.cpp/models/#{encoder_name} ../SalesCoach/Resources/")
      UI.message("Copied #{encoder_name} from whisper.cpp")
    end
    
    if File.exist?("../whisper.cpp/ggml-metal.metal")
      sh("cp ../whisper.cpp/ggml-metal.metal ../SalesCoach/Resources/")
      UI.message("Copied ggml-metal.metal from whisper.cpp")
    end
    
    # Clean and create build directory
    sh("rm -rf ../build && mkdir -p ../build")
    
    # Build using xcodebuild directly (more reliable for CI without code signing)
    xcodebuild(
      project: "SalesCoach/SalesCoach.xcodeproj",
      scheme: "SalesCoach",
      configuration: "Release",
      build_settings: {
        "CODE_SIGN_IDENTITY" => "-",
        "CODE_SIGNING_REQUIRED" => "NO",
        "CODE_SIGNING_ALLOWED" => "NO",
        "CONFIGURATION_BUILD_DIR" => File.expand_path("../build")
      },
      build: true
    )
    
    # Copy whisper-cli to app bundle Resources (Xcode doesn't copy executables without extension)
    app_resources = File.expand_path("../build/SalesCoach.app/Contents/Resources")
    whisper_src = File.expand_path("../SalesCoach/Resources/whisper-cli")
    if File.exist?(whisper_src)
      sh("cp '#{whisper_src}' '#{app_resources}/'")
      sh("chmod +x '#{app_resources}/whisper-cli'")
      UI.success("Copied whisper-cli to app bundle")
    else
      UI.error("whisper-cli not found at #{whisper_src}")
    end
    
    # Copy model and Core ML artifacts to app bundle (in case Xcode didn't include them)
    model_src = File.expand_path("../SalesCoach/Resources/#{model_name}")
    if File.exist?(model_src) && !File.exist?("#{app_resources}/#{model_name}")
      sh("cp '#{model_src}' '#{app_resources}/'")
      UI.success("Copied #{model_name} to app bundle")
    end
    
    encoder_src = File.expand_path("../SalesCoach/Resources/#{encoder_name}")
    if File.exist?(encoder_src) && !File.exist?("#{app_resources}/#{encoder_name}")
      sh("cp -R '#{encoder_src}' '#{app_resources}/'")
      UI.success("Copied #{encoder_name} to app bundle")
    end
    
    metal_src = File.expand_path("../SalesCoach/Resources/ggml-metal.metal")
    if File.exist?(metal_src) && !File.exist?("#{app_resources}/ggml-metal.metal")
      sh("cp '#{metal_src}' '#{app_resources}/'")
      UI.success("Copied ggml-metal.metal to app bundle")
    end
    
    # Create DMG
    sh("hdiutil create -volname SalesCoach -srcfolder ../build/SalesCoach.app -ov -format UDZO ../build/SalesCoach.dmg")
  end

  desc "Build and run the app"
  lane :launch do
    # Build the debug version first
    build_debug
    
    # Launch the app
    app_path = File.expand_path("../build/SalesCoach.app")
    UI.message("Launching SalesCoach...")
    sh("open '#{app_path}'")
  end

  desc "Run tests"
  lane :test do
    run_tests(
      project: "SalesCoach/SalesCoach.xcodeproj",
      scheme: "SalesCoach",
      destination: "platform=macOS",
      skip_build: false
    )
  end
end

